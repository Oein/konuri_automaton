<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Konuri 오토마톤</title>
    <style>
      @font-face {
        font-family: "ONE-Mobile-POP";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/ONE-Mobile-POP.woff")
          format("woff");
        font-weight: normal;
        font-style: normal;
      }

      * {
        font-family: "ONE-Mobile-POP", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell,
          "Open Sans", "Helvetica Neue", sans-serif;
      }

      .playing {
        padding: 8px 16px;
        border-radius: 4px;
        display: inline-block;
        background-color: antiquewhite;
        margin: 4px;
      }

      .playing[data-pwo="0"] {
        background-color: #d74532;
        color: white;
      }
      .playing[data-pwo="2"] {
        background-color: #f19d38;
        color: white;
      }
      .playing[data-pwo="4"] {
        background-color: #fdff83;
      }
      .playing[data-pwo="5"] {
        background-color: #5cc93b;
      }
      .playing[data-pwo="7"] {
        background-color: #4596f1;
      }
      .playing[data-pwo="9"] {
        background-color: #143392;
        color: white;
      }
      .playing[data-pwo="11"] {
        background-color: #9269c6;
        color: white;
      }
      .playing[data-pwo="12"] {
        background-color: #d74532;
        color: white;
      }
      .playing[data-pwo="14"] {
        background-color: #f19d38;
        color: white;
      }
      .playing[data-pwo="16"] {
        background-color: #fdff83;
      }

      #octaContainer,
      #keyStyle {
        transition: all 0.2s ease;
      }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css@1.12/mvp.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
    />
  </head>
  <body>
    <header>
      <h1>Konuri 오토마톤</h1>
      <desc style="display: inline-block">
        v1.0.0 by <a href="https://github.com/Oein">Oein</a>
      </desc>
    </header>
    <main>
      <div>
        MIDI 키보드를 사용할까요?
        <input type="checkbox" id="midiuse" />
      </div>
      <div id="octaContainer">
        옥타브 :
        <div style="display: inline-block" id="octa">4</div>
      </div>
      <div id="keyStyleWarp">
        키 스타일
        <select id="keyStyle" style="display: inline-block">
          <option value="yt">유튜브 스타일</option>
          <option value="ri">123 스타일</option>
          <option value="mk">MIDIKeys 스타일</option>
        </select>
      </div>
      <p>자세한 설명은 <a>Github</a>를 참고 해주세요.</p>
      <h2>재생중인 음</h2>
      <div id="notes"></div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <script>
      let notes = document.getElementById("notes");
      let now_octave = 4;
      let is_midi_mode = false;
      let has_midi_access = false;
      const sampler = new Tone.Sampler({
        urls: {
          C4: "c4.mp3",
          D4: "d4.mp3",
          E4: "e4.mp3",
          F4: "f4.mp3",
          G4: "g4.mp3",
          A4: "a4.mp3",
          B4: "b4.mp3",
          C5: "c5.mp3",
          D5: "d5.mp3",
          E5: "e5.mp3",
        },
        baseUrl: "https://oein.github.io/Riano/audio/konuri/",
        onload: () => {
          console.log("Loaded!");
        },
      }).toDestination();
      const style_123_keymap = {
        Digit1: 0,
        Digit2: 2,
        Digit3: 4,
        Digit4: 5,
        Digit5: 7,
        Digit6: 9,
        Digit7: 11,
        Digit8: 12,
        Digit9: 14,
        Digit0: 16,
      };
      const style_midikeys_keymap = {
        Tab: -8,
        KeyQ: -7,
        Digit2: -6,
        KeyW: -5,
        Digit3: -4,
        KeyE: -3,
        Digit4: -2,
        KeyR: -1,
        KeyT: 0,
        Digit6: 1,
        KeyY: 2,
        Digit7: 3,
        KeyU: 4,
        KeyI: 5,
        Digit9: 6,
        KeyO: 7,
        Digit0: 8,
        KeyP: 9,
        Minus: 10,
        BracketLeft: 11,
        KeyZ: 12,
        KeyS: 13,
        KeyX: 14,
        KeyD: 15,
        KeyC: 16,
        KeyV: 17,
        KeyG: 18,
        KeyB: 19,
        KeyH: 20,
        KeyN: 21,
        KeyJ: 22,
        KeyM: 23,
        Comma: 24,
        KeyL: 25,
        Period: 26,
        Semicolon: 27,
        Slash: 28,
      };
      const style_automk2_keymap = {
        KeyA: 0,
        KeyW: 1,
        KeyS: 2,
        KeyE: 3,
        KeyD: 4,
        KeyF: 5,
        KeyT: 6,
        KeyG: 7,
        KeyY: 8,
        KeyH: 9,
        KeyU: 10,
        KeyJ: 11,
        KeyK: 12,
        KeyO: 13,
        KeyL: 14,
        KeyP: 15,
        Semicolon: 16,
        Quote: 17,
      };
      let playings = [];

      function deleteInArray(array, element) {
        let index = array.indexOf(element);
        if (index != -1) array.splice(index, 1);
        return array;
      }

      function shOctaContainer(state) {
        let opa = "0";
        let trans = "translateY(-1.2rem)";
        let poi = "none";
        let mh = "0px";
        if (state) {
          opa = "1";
          trans = "translateY(0px)";
          poi = "";
          mh = "3rem";
        }

        let elements = [
          document.getElementById("octaContainer"),
          document.getElementById("keyStyleWarp"),
        ];
        elements.forEach((e) => {
          e.style.opacity = opa;
          e.style.transform = trans;
          e.style.pointerEvents = poi;
          e.style.maxHeight = mh;
        });
      }

      function midiUseHandler(use) {
        shOctaContainer(!use);
        is_midi_mode = use;

        if (!use) return;
        removeAllNotes();
        requestMidiAccess();
      }

      function showOctave() {
        document.getElementById("octa").innerText = now_octave;
      }

      function pitchToName(pitch) {
        let kx = {
          0: "C",
          1: "C#",
          2: "D",
          3: "D#",
          4: "E",
          5: "F",
          6: "F#",
          7: "G",
          8: "G#",
          9: "A",
          10: "A#",
          11: "B",
        };

        let octa = Math.floor(pitch / 12);
        let pit = kx[pitch % 12];

        return `${pit}${octa}`;
      }

      function addPlayElement(keyPitch) {
        let di = document.createElement("div");
        di.innerText = pitchToName(keyPitch);
        di.id = `play-${keyPitch}`;
        di.className = "playing";
        di.setAttribute("data-pwo", keyPitch % 12);
        notes.appendChild(di);
        playings.push(keyPitch);
        sampler.triggerAttack(pitchToName(keyPitch));
      }

      function removePlayElement(keyPitch) {
        document.getElementById(`play-${keyPitch}`)?.remove();
        playings = deleteInArray(playings, keyPitch);
        sampler.triggerRelease(pitchToName(keyPitch));
      }

      function removeAllNotes() {
        for (let i = 0; i < 2; i++) playings.forEach(removePlayElement);
      }

      function style_1keyHandler(key, kick) {
        if (typeof style_123_keymap[key] == "undefined") return;
        let pitch = style_123_keymap[key] + now_octave * 12;
        if (kick) addPlayElement(pitch);
        else removePlayElement(pitch);
      }

      function youtube_style_keyHandler(key, kick) {
        if (!kick) return;
        if (typeof style_123_keymap[key] == "undefined") return;
        let pitch = style_123_keymap[key] + now_octave * 12;
        removeAllNotes();
        if (kick) addPlayElement(pitch);
      }

      function midiKeys_style_keyHandler(key, kick) {
        if (typeof style_midikeys_keymap[key] == "undefined") return;
        let pitch = style_midikeys_keymap[key] + now_octave * 12;
        if (kick) addPlayElement(pitch);
        else removePlayElement(pitch);
      }

      function konuri_mk2_style_keyHandler(key, kick) {
        if (typeof style_automk2_keymap[key] == "undefined") return;
        let pitch = style_automk2_keymap[key] + now_octave * 12;
        if (kick) addPlayElement(pitch);
        else removePlayElement(pitch);
      }

      function keyHandler(e, t) {
        console.log(e);
        if (is_midi_mode) return;
        if (e == "Space") return removeAllNotes();
        switch (document.getElementById("keyStyle").value) {
          case "yt":
            now_octave = 4;
            showOctave();
            return youtube_style_keyHandler(e, t);
          case "ri":
            now_octave = 4;
            showOctave();
            return style_1keyHandler(e, t);
          case "mk":
            now_octave = 3;
            showOctave();
            return midiKeys_style_keyHandler(e, t);
        }
      }

      function midiRequestErorHandler(e) {
        console.error(e);
        toastr.error("MIDI 권한을 얻지 못했어요..");
      }

      function onMIDIdeviceMessage(e) {
        if (!is_midi_mode) return;
        let dat = e.data;

        let isNoteOn = dat[0] == 144;
        let key = Number(dat[1]);
        let vol = Number(dat[2]);

        if (isNoteOn) addPlayElement(key);
        else removePlayElement(key);
      }

      function midiEventHandler(midiAccess, e) {
        console.log("MIDI", e);
        if (e?.port?.state == "disconnected") {
          toastr.warning(
            `MIDI 장치가 연결이 해제되었어요. / ${
              e?.port?.name || e?.port?.manufacturer || e?.port?.id
            }`
          );
        }
        for (var input of midiAccess.inputs.values()) {
          toastr.info(
            `새로운 MIDI 장치가 발견되었어요! / ${
              input.name || input.manufacturer || input.id
            }`
          );
          input.onmidimessage = onMIDIdeviceMessage;
        }
      }

      /**
       * @param {MIDIAccess} midiAccess
       */
      function midiRequestSuccessHandler(midiAccess) {
        console.log("Success!");
        has_midi_access = true;
        midiAccess.addEventListener("statechange", (e) =>
          midiEventHandler(midiAccess, e)
        );
        midiEventHandler(midiAccess);
      }

      function requestMidiAccess() {
        if (has_midi_access) return;
        console.log("Requesting midi access");
        navigator
          .requestMIDIAccess()
          .catch(midiRequestErorHandler)
          .then(midiRequestSuccessHandler);
      }

      document.addEventListener(
        "keydown",
        (e) => !e.repeat && keyHandler(e.code, true)
      );
      document.addEventListener("keyup", (e) => keyHandler(e.code, false));
      document
        .getElementById("midiuse")
        .addEventListener("change", (e) => midiUseHandler(e.target.checked));

      shOctaContainer(true);
    </script>
  </body>
</html>
